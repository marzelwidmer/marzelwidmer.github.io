<!DOCTYPE html>
<html lang="en-us">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width">
    <script type="application/javascript" src='https://marzelwidmer.github.io/js/theme-mode.js'></script>
    <link rel="stylesheet" href='https://marzelwidmer.github.io/css/frameworks.min.css' />
    <link rel="stylesheet" href='https://marzelwidmer.github.io/css/github.min.css' />
    <link rel="stylesheet" href='https://marzelwidmer.github.io/css/github-style.css' />
    <link rel="stylesheet" href='https://marzelwidmer.github.io/css/light.css' />
    <link rel="stylesheet" href='https://marzelwidmer.github.io/css/dark.css' />
    <link rel="stylesheet" href='https://marzelwidmer.github.io/css/syntax.css' />
    <title>Promoting Applications Across Environments - Marcel Widmer</title>
    
    <link rel="icon" type="image/x-icon" href='https://marzelwidmer.github.io/images/favicon.ico'>
    
    <meta name="theme-color" content="#1e2327">

    
    <meta name="description"
  content="Create Project We are going to use the CLI to create some projects. Let&amp;rsquo;s create our projects first:
$ oc login $ oc new-project development --display-name=&amp;#34;Development Environment&amp;#34; $ oc new-project testing --display-name=&amp;#34;Testing Environment&amp;#34; $ oc new-project production --display-name=&amp;#34;Production Environment&amp;#34; $ oc new-project jenkins --display-name=&amp;#34;Jenkins CI/CD&amp;#34; Install Jenkins Create a Jenkins in the Jenkins CI/CD project with some storage. Take the Jenkins from the catalog and set some more memory and volume capacity on it." />
<meta name="keywords"
  content='google analytics' />
<meta name="robots" content="noodp" />
<link rel="canonical" href="https://marzelwidmer.github.io/post/blog/2019/2019-08-28-multiple-project-promoting/" />


<meta name="twitter:card" content="summary" />
<meta name="twitter:title" content="Promoting Applications Across Environments - Marcel Widmer" />
<meta name="twitter:description"
  content="Create Project We are going to use the CLI to create some projects. Let&amp;rsquo;s create our projects first:
$ oc login $ oc new-project development --display-name=&amp;#34;Development Environment&amp;#34; $ oc new-project testing --display-name=&amp;#34;Testing Environment&amp;#34; $ oc new-project production --display-name=&amp;#34;Production Environment&amp;#34; $ oc new-project jenkins --display-name=&amp;#34;Jenkins CI/CD&amp;#34; Install Jenkins Create a Jenkins in the Jenkins CI/CD project with some storage. Take the Jenkins from the catalog and set some more memory and volume capacity on it." />
<meta name="twitter:site" content="https://marzelwidmer.github.io/" />
<meta name="twitter:creator" content="" />
<meta name="twitter:image"
  content="https://marzelwidmer.github.io/">


<meta property="og:type" content="article" />
<meta property="og:title" content="Promoting Applications Across Environments - Marcel Widmer">
<meta property="og:description"
  content="Create Project We are going to use the CLI to create some projects. Let&amp;rsquo;s create our projects first:
$ oc login $ oc new-project development --display-name=&amp;#34;Development Environment&amp;#34; $ oc new-project testing --display-name=&amp;#34;Testing Environment&amp;#34; $ oc new-project production --display-name=&amp;#34;Production Environment&amp;#34; $ oc new-project jenkins --display-name=&amp;#34;Jenkins CI/CD&amp;#34; Install Jenkins Create a Jenkins in the Jenkins CI/CD project with some storage. Take the Jenkins from the catalog and set some more memory and volume capacity on it." />
<meta property="og:url" content="https://marzelwidmer.github.io/post/blog/2019/2019-08-28-multiple-project-promoting/" />
<meta property="og:site_name" content="Promoting Applications Across Environments" />
<meta property="og:image"
  content="https://marzelwidmer.github.io/">
<meta property="og:image:width" content="2048">
<meta property="og:image:height" content="1024">

<meta property="article:published_time" content="2019-09-18 00:00:00 &#43;0000 UTC" />










</head>

<body>
  <div style="position: relative">
  <header class="Header js-details-container Details px-3 px-md-4 px-lg-5 flex-wrap flex-md-nowrap open Details--on">
    <div class="Header-item mobile-none" style="margin-top: -4px; margin-bottom: -4px;">
      <a class="Header-link" href="https://marzelwidmer.github.io/">
        <img class="octicon" height="32" width="32" src="/images/GitHub-Mark-Light-32px.png">
      </a>
    </div>
    <div class="Header-item d-md-none">
      <button class="Header-link btn-link js-details-target" type="button"
        onclick="document.querySelector('#header-search').style.display = document.querySelector('#header-search').style.display == 'none'? 'block': 'none'">
        <img height="24" class="octicon octicon-three-bars" width="24" src="/images/GitHub-Mark-Light-32px.png">
      </button>
    </div>
    <div style="display: none;" id="header-search"
      class="Header-item Header-item--full flex-column flex-md-row width-full flex-order-2 flex-md-order-none mr-0 mr-md-3 mt-3 mt-md-0 Details-content--hidden-not-important d-md-flex">
      <div
        class="Header-search header-search flex-auto js-site-search position-relative flex-self-stretch flex-md-self-auto mb-3 mb-md-0 mr-0 mr-md-3 scoped-search site-scoped-search js-jump-to">
        <div class="position-relative">
          <form target="_blank" action="https://www.google.com/search" accept-charset="UTF-8" method="get"
            autocomplete="off">
            <label
              class="Header-search-label form-control input-sm header-search-wrapper p-0 js-chromeless-input-container header-search-wrapper-jump-to position-relative d-flex flex-justify-between flex-items-center">
              <input type="text"
                class="Header-search-input form-control input-sm header-search-input jump-to-field js-jump-to-field js-site-search-focus js-site-search-field is-clearable"
                name="q" value="" placeholder="Search" autocomplete="off">
              <input type="hidden" name="q" value="site:https://marzelwidmer.github.io/">
            </label>
          </form>
        </div>
      </div>
    </div>

    <div class="Header-item Header-item--full flex-justify-center d-md-none position-relative">
      <a class="Header-link " href="https://marzelwidmer.github.io/">
        <img class="octicon octicon-mark-github v-align-middle" height="32" width="32" src="/images/GitHub-Mark-Light-32px.png">
      </a>
    </div>
    <div class="Header-item" style="margin-right: 0;">
      <a href="javascript:void(0)" class="Header-link no-select" onclick="switchTheme()">
        <svg style="fill: var(--color-profile-color-modes-toggle-moon);" class="no-select" viewBox="0 0 16 16"
          version="1.1" width="16" height="16">
          <path fill-rule="evenodd" clip-rule="evenodd"
            d="M4.52208 7.71754C7.5782 7.71754 10.0557 5.24006 10.0557 2.18394C10.0557 1.93498 10.0392 1.68986 10.0074 1.44961C9.95801 1.07727 10.3495 0.771159 10.6474 0.99992C12.1153 2.12716 13.0615 3.89999 13.0615 5.89383C13.0615 9.29958 10.3006 12.0605 6.89485 12.0605C3.95334 12.0605 1.49286 10.001 0.876728 7.24527C0.794841 6.87902 1.23668 6.65289 1.55321 6.85451C2.41106 7.40095 3.4296 7.71754 4.52208 7.71754Z">
          </path>
        </svg>
      </a>
    </div>
  </header>
</div>

  
<div>
  <main>
    <div class="gisthead pagehead bg-gray-light pb-0 pt-3 mb-4">
      <div class="px-0">
        <div class="mb-3 d-flex px-3 px-md-3 px-lg-5">
          <div class="flex-auto min-width-0 width-fit mr-3">
            <div class="d-flex">
              <div class="d-none d-md-block">
                <a class="avatar mr-2 flex-shrink-0" href="https://marzelwidmer.github.io/">
                  <img class=" avatar-user"
                    src="/images/avatar.png"
                    width="32" height="32"></a>
              </div>
              <div class="d-flex flex-column">
                <h1 class="break-word f3 text-normal mb-md-0 mb-1">
                  <span class="author">
                    <a href="https://marzelwidmer.github.io/">Marcel Widmer</a></span><span
                    class="path-divider">/</span><strong class="css-truncate-target mr-1" style="max-width: 410px"><a
                      href="https://marzelwidmer.github.io/post/blog/2019/2019-08-28-multiple-project-promoting/">Promoting Applications Across Environments</a></strong>
                </h1>
                <div class="note m-0">
                  Created <relative-time datetime="Wed, 18 Sep 2019 00:00:00 &#43;0000"
                    class="no-wrap">
                    Wed, 18 Sep 2019 00:00:00 &#43;0000</relative-time>

                  
                  <span class="file-info-divider"></span>
                  Modified <relative-time datetime="Mon, 19 Feb 2024 10:19:35 &#43;0100"
                    class="no-wrap">
                    Mon, 19 Feb 2024 10:19:35 &#43;0100</relative-time>
                  
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="container-lg px-3 new-discussion-timeline">
      <div class="repository-content gist-content">
        <div>
          <div class="js-gist-file-update-container js-task-list-container file-box">
            <div id="file-pytest" class="file my-2">
              <div id="post-header" class="file-header d-flex flex-md-items-center flex-items-start sticky-header" style="z-index: 2">
                <div class="file-info d-flex flex-md-items-center flex-items-start flex-order-1 flex-auto">
                  <div class="text-mono f6 flex-auto pr-3 flex-order-2 flex-md-order-1 mt-2 mt-md-0">
                    
                    <summary id="toc-toggle" onclick="clickToc()" class="btn btn-octicon m-0 mr-2 p-2">
                      <svg aria-hidden="true" viewBox="0 0 16 16" height="16" width="16" class="octicon octicon-list-unordered">
                        <path fill-rule="evenodd" d="M2 4a1 1 0 100-2 1 1 0 000 2zm3.75-1.5a.75.75 0 000 1.5h8.5a.75.75 0 000-1.5h-8.5zm0 5a.75.75 0 000 1.5h8.5a.75.75 0 000-1.5h-8.5zm0 5a.75.75 0 000 1.5h8.5a.75.75 0 000-1.5h-8.5zM3 8a1 1 0 11-2 0 1 1 0 012 0zm-1 6a1 1 0 100-2 1 1 0 000 2z"></path>
                      </svg>
                    </summary>
                    <details-menu class="SelectMenu" id="toc-details" style="display: none;">
                      <div class="SelectMenu-modal rounded-3 mt-1" style="max-height: 340px;">
                        <div class="SelectMenu-list SelectMenu-list--borderless p-2" style="overscroll-behavior: contain;" id="toc-list">
                        </div>
                      </div>
                    </details-menu>
                      1605 Words
                    

                  </div>
                  <div class="file-actions flex-order-2 pt-0">
                    
                    
                    <a class="muted-link mr-3" href="/tags/k8s">
                      <svg class="octicon octicon-tag" viewBox="0 0 16 16" version="1.1" width="16" height="16">
                        <path fill-rule="evenodd"
                          d="M2.5 7.775V2.75a.25.25 0 01.25-.25h5.025a.25.25 0 01.177.073l6.25 6.25a.25.25 0 010 .354l-5.025 5.025a.25.25 0 01-.354 0l-6.25-6.25a.25.25 0 01-.073-.177zm-1.5 0V2.75C1 1.784 1.784 1 2.75 1h5.025c.464 0 .91.184 1.238.513l6.25 6.25a1.75 1.75 0 010 2.474l-5.026 5.026a1.75 1.75 0 01-2.474 0l-6.25-6.25A1.75 1.75 0 011 7.775zM6 5a1 1 0 100 2 1 1 0 000-2z">
                        </path>
                      </svg>
                      k8s
                    </a>
                    
                    <a class="muted-link mr-3" href="/tags/ci/cd">
                      <svg class="octicon octicon-tag" viewBox="0 0 16 16" version="1.1" width="16" height="16">
                        <path fill-rule="evenodd"
                          d="M2.5 7.775V2.75a.25.25 0 01.25-.25h5.025a.25.25 0 01.177.073l6.25 6.25a.25.25 0 010 .354l-5.025 5.025a.25.25 0 01-.354 0l-6.25-6.25a.25.25 0 01-.073-.177zm-1.5 0V2.75C1 1.784 1.784 1 2.75 1h5.025c.464 0 .91.184 1.238.513l6.25 6.25a1.75 1.75 0 010 2.474l-5.026 5.026a1.75 1.75 0 01-2.474 0l-6.25-6.25A1.75 1.75 0 011 7.775zM6 5a1 1 0 100 2 1 1 0 000-2z">
                        </path>
                      </svg>
                      CI/CD
                    </a>
                    
                    <a class="muted-link mr-3" href="/tags/spring-boot">
                      <svg class="octicon octicon-tag" viewBox="0 0 16 16" version="1.1" width="16" height="16">
                        <path fill-rule="evenodd"
                          d="M2.5 7.775V2.75a.25.25 0 01.25-.25h5.025a.25.25 0 01.177.073l6.25 6.25a.25.25 0 010 .354l-5.025 5.025a.25.25 0 01-.354 0l-6.25-6.25a.25.25 0 01-.073-.177zm-1.5 0V2.75C1 1.784 1.784 1 2.75 1h5.025c.464 0 .91.184 1.238.513l6.25 6.25a1.75 1.75 0 010 2.474l-5.026 5.026a1.75 1.75 0 01-2.474 0l-6.25-6.25A1.75 1.75 0 011 7.775zM6 5a1 1 0 100 2 1 1 0 000-2z">
                        </path>
                      </svg>
                      Spring Boot
                    </a>
                    
                    
                  </div>
                </div>
              </div>


              <div class="Box-body px-5 pb-5" style="z-index: 1">
                <article class="markdown-body entry-content container-lg"><h2 id="CreateProject">Create Project </h2>
<p>We are going to use the CLI to create some projects.
Let&rsquo;s create our projects first:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ oc login  
</span></span><span class="line"><span class="cl">$ oc new-project development --display-name<span class="o">=</span><span class="s2">&#34;Development Environment&#34;</span>
</span></span><span class="line"><span class="cl">$ oc new-project testing --display-name<span class="o">=</span><span class="s2">&#34;Testing Environment&#34;</span>    
</span></span><span class="line"><span class="cl">$ oc new-project production --display-name<span class="o">=</span><span class="s2">&#34;Production Environment&#34;</span>    
</span></span><span class="line"><span class="cl">$ oc new-project jenkins --display-name<span class="o">=</span><span class="s2">&#34;Jenkins CI/CD&#34;</span>  
</span></span></code></pre></div><h2 id="InstallJenkins">Install Jenkins </h2>
<p>Create a Jenkins in the <code>Jenkins CI/CD</code> project with some storage. Take the Jenkins from the catalog and set some more memory and volume capacity on it.
Everything else we let the default values.
Login with your Openshift account to the <code>Jenkins BlueOcean</code>.</p>
<p><img src="/static/multiple-project-promoting/Jenkins-from-catalog-1.png" alt="Jenkins-From-Catalog-1">
<img src="/static/multiple-project-promoting/Jenkins-from-catalog-2.png" alt="Jenkins-From-Catalog-2">
<img src="/static/multiple-project-promoting/Jenkins-from-catalog-3.png" alt="Jenkins-From-Catalog-3"></p>
<h2 id="configure-jenkins-maven-slave---concurrency-limit">Configure Jenkins Maven Slave - Concurrency Limit</h2>
<p>Let&rsquo;s configure out <code>Maven-Slave</code> concurrency limit to <code>5</code> in order that we later want build more then one project.
Please go to the Jenkins Configuration Page <code>https://&lt;jenkins&gt;/configure</code> in the section <code>Cloud/Kubernetes Pod Template</code> and search for the <code>Maven</code> Pod.</p>
<p><img src="/static/multiple-project-promoting/Maven-Pod-Concurrency-Limit.png" alt="Maven-Pod-Concurrency-Limit"></p>
<h2 id="InstallJenkinsWithCLI">Install Jenkins with CLI</h2>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ oc new-app jenkins-persistent --name jenkins --param <span class="nv">ENABLE_OAUTH</span><span class="o">=</span><span class="nb">true</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>        --param <span class="nv">MEMORY_LIMIT</span><span class="o">=</span>2Gi --param <span class="nv">VOLUME_CAPACITY</span><span class="o">=</span>4Gi -n jenkins
</span></span></code></pre></div><h3 id="jenkins-file-from-source-repository">Jenkins File From Source Repository</h3>
<p>The pipeline <a href="https://raw.githubusercontent.com/marzelwidmer/marzelwidmer.github.io/master/img/2019/multiple-project-promoting/Promotion-Jenkinsfile">Jenkinsfile</a> is provided in the source repository.</p>
<h2 id="AddEditRoleToServiceAccountJenkins">Add Edit Role To ServiceAccount Jenkins </h2>
<p>Let’s add in RBAC to our projects to allow the different service accounts to build, pro‐ mote, and tag images.
First we will allow the cicd project’s Jenkins service account edit access to all of our projects:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ oc policy add-role-to-user edit system:serviceaccount:jenkins:jenkins -n development
</span></span><span class="line"><span class="cl">$ oc policy add-role-to-user edit system:serviceaccount:jenkins:jenkins -n testing
</span></span><span class="line"><span class="cl">$ oc policy add-role-to-user edit system:serviceaccount:jenkins:jenkins -n production
</span></span></code></pre></div><h2 id="AddRoleToGroup">Add Role To Group </h2>
<p>That we can pull our image from <code>testing</code> and <code>production</code> environment from the <code>development</code> registry. This is needed for pulling the Images across the projects.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ oc policy add-role-to-group system:image-puller system:serviceaccounts:testing  <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>        -n development
</span></span><span class="line"><span class="cl">$ oc policy add-role-to-group system:image-puller system:serviceaccounts:production <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>        -n development
</span></span></code></pre></div><h1 id="DeployApplication">Deploy Application </h1>
<p>Let&rsquo;s deploy first the application with the <a href="https://docs.openshift.com/container-platform/3.11/creating_images/s2i.html">S2i strategy</a>.
before we will create the delivery pipeline.</p>
<h2 id="DevelopmentEnvironmentDeployment">Development Environment Deployment </h2>
<p>Let&rsquo;s change first the project to to development with the <code>oc project development</code> command.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ oc project development
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Now using project <span class="s2">&#34;development&#34;</span> on server <span class="s2">&#34;https://console.c3smonkey.ch:8443&#34;</span>.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Creat a new app with <span class="sb">`</span>oc new-app<span class="sb">`</span>
</span></span></code></pre></div><p>We will use here the <a href="https://hub.docker.com/r/fabric8/s2i-java">fabric8/s2i-java</a> to deploy our application and will point it to the master branch with the command <code>oc new-app</code>
We also want expose the service <code>oc expose svc/catalog-service</code> to get a URL with the command <code>oc get route catalog-service</code> we will see the URL on the terminal.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ oc new-app fabric8/s2i-java:latest-java11~https://github.com/marzelwidmer/catalog-service.git#master<span class="p">;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    oc expose svc/catalog-service<span class="p">;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    oc get route catalog-service
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">--&gt; Found Docker image <span class="m">6414174</span> <span class="o">(</span><span class="m">7</span> weeks old<span class="o">)</span> from Docker Hub <span class="k">for</span> <span class="s2">&#34;fabric8/s2i-java:latest-java11&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  Java Applications
</span></span><span class="line"><span class="cl">  -----------------
</span></span><span class="line"><span class="cl">  Platform <span class="k">for</span> building and running plain Java applications <span class="o">(</span>fat-jar and flat classpath<span class="o">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  Tags: builder, java
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  * An image stream tag will be created as <span class="s2">&#34;s2i-java:latest-java11&#34;</span> that will track the <span class="nb">source</span> image
</span></span><span class="line"><span class="cl">  * A <span class="nb">source</span> build using <span class="nb">source</span> code from https://github.com/marzelwidmer/catalog-service.git#master will be created
</span></span><span class="line"><span class="cl">    * The resulting image will be pushed to image stream tag <span class="s2">&#34;catalog-service:latest&#34;</span>
</span></span><span class="line"><span class="cl">    * Every <span class="nb">time</span> <span class="s2">&#34;s2i-java:latest-java11&#34;</span> changes a new build will be triggered
</span></span><span class="line"><span class="cl">  * This image will be deployed in deployment config <span class="s2">&#34;catalog-service&#34;</span>
</span></span><span class="line"><span class="cl">  * Ports 8080/tcp, 8778/tcp, 9779/tcp will be load balanced by service <span class="s2">&#34;catalog-service&#34;</span>
</span></span><span class="line"><span class="cl">    * Other containers can access this service through the hostname <span class="s2">&#34;catalog-service&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">--&gt; Creating resources ...
</span></span><span class="line"><span class="cl">    imagestream.image.openshift.io <span class="s2">&#34;s2i-java&#34;</span> created
</span></span><span class="line"><span class="cl">    imagestream.image.openshift.io <span class="s2">&#34;catalog-service&#34;</span> created
</span></span><span class="line"><span class="cl">    buildconfig.build.openshift.io <span class="s2">&#34;catalog-service&#34;</span> created
</span></span><span class="line"><span class="cl">    deploymentconfig.apps.openshift.io <span class="s2">&#34;catalog-service&#34;</span> created
</span></span><span class="line"><span class="cl">    service <span class="s2">&#34;catalog-service&#34;</span> created
</span></span><span class="line"><span class="cl">--&gt; Success
</span></span><span class="line"><span class="cl">    Build scheduled, use <span class="s1">&#39;oc logs -f bc/catalog-service&#39;</span> to track its progress.
</span></span><span class="line"><span class="cl">    Application is not exposed. You can expose services to the outside world by executing one or more of the commands below:
</span></span><span class="line"><span class="cl">     <span class="s1">&#39;oc expose svc/catalog-service&#39;</span>
</span></span><span class="line"><span class="cl">    Run <span class="s1">&#39;oc status&#39;</span> to view your app.
</span></span><span class="line"><span class="cl">route.route.openshift.io/catalog-service exposed
</span></span><span class="line"><span class="cl">NAME             HOST/PORT                                      PATH  SERVICES         PORT      TERMINATION  WILDCARD
</span></span><span class="line"><span class="cl">catalog-service  catalog-service-development.apps.c3smonkey.ch        catalog-service  8080-tcp               None
</span></span></code></pre></div><p>Now take a look in the OpenShift Console project <code>development</code></p>
<p><img src="/static/multiple-project-promoting/catalog-service-dev-deployment.png" alt="catalog-service-dev-deployment"></p>
<p>Let&rsquo;s take a look what the S2i crated for us.
This can be done with the following command <code>oc get all -n development --selector app=catalog-service</code>.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ oc get all -n development --selector <span class="nv">app</span><span class="o">=</span>catalog-service                                  
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">NAME                          READY   STATUS    RESTARTS   AGE
</span></span><span class="line"><span class="cl">pod/catalog-service-1-2rv5r   1/1     Running   <span class="m">0</span>          56m
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">NAME                                      DESIRED   CURRENT   READY   AGE
</span></span><span class="line"><span class="cl">replicationcontroller/catalog-service-1   <span class="m">1</span>         <span class="m">1</span>         <span class="m">1</span>       56m
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">NAME                      TYPE        CLUSTER-IP       EXTERNAL-IP   PORT<span class="o">(</span>S<span class="o">)</span>                      AGE
</span></span><span class="line"><span class="cl">service/catalog-service   ClusterIP   172.30.216.240   &lt;none&gt;        8080/TCP,8778/TCP,9779/TCP   57m
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">NAME                                                 REVISION   DESIRED   CURRENT   TRIGGERED BY
</span></span><span class="line"><span class="cl">deploymentconfig.apps.openshift.io/catalog-service   <span class="m">1</span>          <span class="m">1</span>         <span class="m">1</span>         config,image<span class="o">(</span>catalog-service:latest<span class="o">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">NAME                                             TYPE     FROM         LATEST
</span></span><span class="line"><span class="cl">buildconfig.build.openshift.io/catalog-service   Source   Git@master   <span class="m">1</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">NAME                                         TYPE     FROM          STATUS     STARTED             DURATION
</span></span><span class="line"><span class="cl">build.build.openshift.io/catalog-service-1   Source   Git@b49dff4   Complete   About an hour ago   1m10s
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">NAME                                             DOCKER REPO                                                    TAGS            
</span></span><span class="line"><span class="cl">imagestream.image.openshift.io/catalog-service   docker-registry.default.svc:5000/development/catalog-service   latest           
</span></span><span class="line"><span class="cl">imagestream.image.openshift.io/s2i-java          docker-registry.default.svc:5000/development/s2i-java          latest-java11   
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">NAME                                       HOST/PORT                                       PATH   SERVICES          PORT        WILDCARD
</span></span><span class="line"><span class="cl">route.route.openshift.io/catalog-service   catalog-service-development.apps.c3smonkey.ch          catalog-service   8080-tcp    None
</span></span></code></pre></div><h2 id="TestAPI">Test API on Development </h2>
<p>Now let&rsquo;s test the amazing <code>/api/v1/animals/rando</code> API from <code>catalog-service</code> by hitting the following Rest endpoint 50 times.
in a bash shell with the following command. <code>for x in (seq 50); http &quot;http://catalog-service-development.apps.c3smonkey.ch/api/v1/animals/random&quot;; end</code></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ ~ 🐠 
</span></span><span class="line"><span class="cl"><span class="k">for</span> x in <span class="o">(</span>seq 50<span class="o">)</span><span class="p">;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>     http <span class="s2">&#34;http://catalog-service-development.apps.c3smonkey.ch/api/v1/animals/random&#34;</span><span class="p">;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>end                                                                               
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">HTTP/1.1 <span class="m">200</span> OK
</span></span><span class="line"><span class="cl">Cache-control: private
</span></span><span class="line"><span class="cl">Content-Length: <span class="m">14</span>
</span></span><span class="line"><span class="cl">Content-Type: text/plain<span class="p">;</span><span class="nv">charset</span><span class="o">=</span>UTF-8
</span></span><span class="line"><span class="cl">Set-Cookie: <span class="nv">1e5e1500c4996e7978ef9efb67d863a1</span><span class="o">=</span>1e12d12873c24c5c17782f3da537ed6a<span class="p">;</span> <span class="nv">path</span><span class="o">=</span>/<span class="p">;</span> HttpOnly
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Burrowing Frog
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">HTTP/1.1 <span class="m">200</span> OK
</span></span><span class="line"><span class="cl">Cache-control: private
</span></span><span class="line"><span class="cl">Content-Length: <span class="m">14</span>
</span></span><span class="line"><span class="cl">Content-Type: text/plain<span class="p">;</span><span class="nv">charset</span><span class="o">=</span>UTF-8
</span></span><span class="line"><span class="cl">Set-Cookie: <span class="nv">1e5e1500c4996e7978ef9efb67d863a1</span><span class="o">=</span>1e12d12873c24c5c17782f3da537ed6a<span class="p">;</span> <span class="nv">path</span><span class="o">=</span>/<span class="p">;</span> HttpOnly
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Dogo Argentino
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">HTTP/1.1 <span class="m">200</span> OK
</span></span></code></pre></div><h2 id="TestingEnvironmentDeployment">Testing Environment Deployment</h2>
<p>Let&rsquo;s change first to the testing project with <code>oc project testing</code>.
We remember that we have in our setup only one docker registry from this registry we want promote our Docker images to other projects in our OpenShift Cluster setup.
The access is now available because we did the <a href="#AddRoleToGroup">Add Role To Group</a>. Now let&rsquo;s take a look at the ImageStream in the project <code>development</code> with the
following command <code>oc get is -n development</code> we will get the docker registry we need to create the a deployment configuration in the project <code>testing</code>. We are searching for the
<code>catalog-service</code> docker registry.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ oc get is -n development
</span></span><span class="line"><span class="cl">NAME              DOCKER REPO                                                    TAGS            UPDATED
</span></span><span class="line"><span class="cl">catalog-service   docker-registry.default.svc:5000/development/catalog-service   latest          About an hour ago
</span></span><span class="line"><span class="cl">s2i-java          docker-registry.default.svc:5000/development/s2i-java          latest-java11   About an hour ago
</span></span></code></pre></div><p>Now let&rsquo;s create a deployment configuration for the <code>promoteQA</code> tag with <code>oc create dc catalog-service --image=docker-registry.default.svc:5000/development/catalog-service:promoteQA</code>
Our Jenkins pipeline is configured to interact with this tag to promote between the environments.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ oc create dc catalog-service --image<span class="o">=</span>docker-registry.default.svc:5000/development/catalog-service:promoteQA
</span></span><span class="line"><span class="cl">deploymentconfig.apps.openshift.io/catalog-service created
</span></span></code></pre></div><p>Now we have to expose the <code>dc/catalog-service</code> with the port <code>8080</code> who our Spring Boot App is running on.<br>
This easy done with the <code>oc expose dc catalog-service --port=8080</code> command.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ oc expose dc catalog-service --port<span class="o">=</span><span class="m">8080</span>
</span></span><span class="line"><span class="cl">service/catalog-service exposed
</span></span></code></pre></div><p>Now also expose the service and get the route <code>oc expose service catalog-service --name=catalog-service; oc get route</code></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ oc expose service catalog-service --name<span class="o">=</span>catalog-service<span class="p">;</span> oc get route
</span></span><span class="line"><span class="cl">route.route.openshift.io/catalog-service exposed
</span></span><span class="line"><span class="cl">NAME              HOST/PORT                                   PATH   SERVICES          PORT   TERMINATION   WILDCARD
</span></span><span class="line"><span class="cl">catalog-service   catalog-service-testing.apps.c3smonkey.ch          catalog-service   <span class="m">8080</span>                 None
</span></span></code></pre></div><p>We have to patch the <code>dc</code> <code>imagePullPolicy</code> from <code>IfNotPresent</code> to <code>Always</code> with <code>oc patch</code> command. The default is set to <code>IfNotPresent</code>,
but we wish to always trigger a deployment when we tag a new image</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ oc patch dc/catalog-service  -p <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>      <span class="s1">&#39;{&#34;spec&#34;:{&#34;template&#34;:{&#34;spec&#34;:{&#34;containers&#34;:[{&#34;name&#34;:&#34;default-container&#34;,&#34;imagePullPolicy&#34;:&#34;Always&#34;}]}}}}&#39;</span>
</span></span></code></pre></div><h2 id="ProductionEnvironmentDeployment">Production Environment Deployment</h2>
<p>The same what we did on the <a href="#TestingEnvironmentDeployment">Testing Environment Deployment </a> we also do now on the production environment.
But we configure the promotion tag <code>promotePRD</code> in the deployment configuration.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ oc project production
</span></span><span class="line"><span class="cl">$ oc create dc catalog-service --image<span class="o">=</span>docker-registry.default.svc:5000/development/catalog-service:promotePRD
</span></span><span class="line"><span class="cl">$ oc patch dc/catalog-service  -p <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>     <span class="s1">&#39;{&#34;spec&#34;:{&#34;template&#34;:{&#34;spec&#34;:{&#34;containers&#34;:[{&#34;name&#34;:&#34;default-container&#34;,&#34;imagePullPolicy&#34;:&#34;Always&#34;}]}}}}&#39;</span>
</span></span><span class="line"><span class="cl">$ oc expose dc catalog-service --port<span class="o">=</span><span class="m">8080</span>
</span></span><span class="line"><span class="cl">$ oc expose svc/catalog-service
</span></span></code></pre></div><h2 id="JenkinsPipeline">Jenkins Pipeline </h2>
<p>So now let&rsquo;s create a <code>BuildConfig</code> for the <code>catalaog-service</code> with the
following <a href="/multiple-project-promoting/catalog-service-pipeline.yaml">catalog-service-jenkins-pipeline</a> configuration
in the Jenkins namespace (project) let&rsquo;s do it with <code>oc create -n jenkins -f https://blog.marcelwidmer.org/openshift-pipeline/catalog-service-pipeline.yaml</code></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ oc create -n jenkins -f <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    https://blog.marcelwidmer.org/openshift-pipeline/catalog-service-pipeline.yaml
</span></span><span class="line"><span class="cl">buildconfig.build.openshift.io/catalog-service-pipeline created
</span></span></code></pre></div><p>When you go now in the OpenShift <a href="https://console.c3smonkey.ch:8443/console/project/jenkins/browse/pipelines">Console</a> in the project <code>Jenkins</code> in the section.
<code>Builds/Pipelines</code> you will something like this.
<img src="/static/multiple-project-promoting/catalog-service-pipeline-created.png" alt="Catalog Service Pipeline"></p>
<h3 id="run-jenkins-pipeline">Run Jenkins Pipeline</h3>
<p>Now is time to run the pipeline with the command <code>oc start-build catalog-service-pipeline -n jenkins</code></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ oc start-build catalog-service-pipeline -n jenkins
</span></span><span class="line"><span class="cl">build.build.openshift.io/catalog-service-pipeline-1 started
</span></span></code></pre></div><p>After a while you will see something like this. For production deployment we configured our pipeline with a approvable step.</p>
<p><img src="/static/multiple-project-promoting/catalog-service-pipeline-approvable.png" alt="Catalog Service Pipeline approvable"></p>
<p>Now is time to approve the application and hit the
After the approve button in the pipeline to deploy to the production namespace.</p>
<p><img src="/static/multiple-project-promoting/catalog-service-pipeline-success.png" alt="Catalog Service Pipeline success"></p>
<h2 id="WebHooks">WebHooks </h2>
<p>Now let&rsquo;s creat a WebHook. So when we push something in our <code>catalog-service</code> the pipeline start run.
Change first to the <code>jenkins</code> project again with <code>oc project jenkins</code></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ oc project jenkins
</span></span><span class="line"><span class="cl">Now using project <span class="s2">&#34;jenkins&#34;</span> on server <span class="s2">&#34;https://console.c3smonkey.ch:8443&#34;</span>
</span></span></code></pre></div><p>Now check the <code>Buildconfig</code> with <code>oc describe bc/catalog-service-pipeline</code></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ oc describe bc/catalog-service-pipeline                                                                                                                                               
</span></span><span class="line"><span class="cl">Name:		catalog-service-pipeline
</span></span><span class="line"><span class="cl">Namespace:	jenkins
</span></span><span class="line"><span class="cl">Created:	<span class="m">2</span> hours ago
</span></span><span class="line"><span class="cl">Labels:		<span class="nv">app</span><span class="o">=</span>catalog-service-pipeline
</span></span><span class="line"><span class="cl">		<span class="nv">name</span><span class="o">=</span>catalog-service-pipeline
</span></span><span class="line"><span class="cl">Annotations:	&lt;none&gt;
</span></span><span class="line"><span class="cl">Latest Version:	<span class="m">1</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Strategy:		JenkinsPipeline
</span></span><span class="line"><span class="cl">URL:			https://github.com/marzelwidmer/catalog-service.git
</span></span><span class="line"><span class="cl">Ref:			master
</span></span><span class="line"><span class="cl">Jenkinsfile path:	Jenkinsfile
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Build Run Policy:	Serial
</span></span><span class="line"><span class="cl">Triggered by:		&lt;none&gt;
</span></span><span class="line"><span class="cl">Builds History Limit:
</span></span><span class="line"><span class="cl">	Successful:	<span class="m">5</span>
</span></span><span class="line"><span class="cl">	Failed:		<span class="m">5</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Build				Status		Duration	Creation Time
</span></span><span class="line"><span class="cl">catalog-service-pipeline-1 	<span class="nb">complete</span> 	8m12s 		2019-09-05 13:54:18 +0200 CEST
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Events:	&lt;none&gt;
</span></span></code></pre></div><p>At the moment we don&rsquo;t have any GitHub Hooks configured.</p>
<h2 id="buildconfig-triggers">BuildConfig Triggers</h2>
<p>With the following command you can set GitHub WebHook trigger. This will create a secret for us and configured a WebHook in our BuildConfig.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ oc <span class="nb">set</span> triggers bc/catalog-service-pipeline --from-github 
</span></span></code></pre></div><p>When we run again the <code>oc describe bc/catalog-service-pipeline</code> command we will see that we have a <code>bc</code> like below.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ oc describe bc/catalog-service-pipeline                                                                                                                                             
</span></span><span class="line"><span class="cl">Name:		catalog-service-pipeline
</span></span><span class="line"><span class="cl">Namespace:	jenkins
</span></span><span class="line"><span class="cl">Created:	<span class="m">2</span> hours ago
</span></span><span class="line"><span class="cl">Labels:		<span class="nv">app</span><span class="o">=</span>catalog-service-pipeline
</span></span><span class="line"><span class="cl">		<span class="nv">name</span><span class="o">=</span>catalog-service-pipeline
</span></span><span class="line"><span class="cl">Annotations:	&lt;none&gt;
</span></span><span class="line"><span class="cl">Latest Version:	<span class="m">1</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Strategy:		JenkinsPipeline
</span></span><span class="line"><span class="cl">URL:			https://github.com/marzelwidmer/catalog-service.git
</span></span><span class="line"><span class="cl">Ref:			master
</span></span><span class="line"><span class="cl">Jenkinsfile path:	Jenkinsfile
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Build Run Policy:	Serial
</span></span><span class="line"><span class="cl">Triggered by:		&lt;none&gt;
</span></span><span class="line"><span class="cl">Webhook GitHub:
</span></span><span class="line"><span class="cl">	URL:	https://okd.ch/apis/build.openshift.io/v1/namespaces/jenkins/buildconfigs/catalog-service-pipeline/webhooks/&lt;secret&gt;/github
</span></span><span class="line"><span class="cl">Builds History Limit:
</span></span><span class="line"><span class="cl">	Successful:	<span class="m">5</span>
</span></span><span class="line"><span class="cl">	Failed:		<span class="m">5</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Build				Status		Duration	Creation Time
</span></span><span class="line"><span class="cl">catalog-service-pipeline-1 	<span class="nb">complete</span> 	8m12s 		2019-09-05 13:54:18 +0200 CEST
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Events:	&lt;none&gt;
</span></span></code></pre></div><blockquote>
<p><strong><em>Note:</em></strong> The URL <!-- raw HTML omitted --> we will replace with a secret. This is just an place holder in the URL.
<a href="https://console.c3smonkey.ch:8443/apis/build.openshift.io/v1/namespaces/jenkins/buildconfigs/catalog-service-pipeline/webhooks/">https://console.c3smonkey.ch:8443/apis/build.openshift.io/v1/namespaces/jenkins/buildconfigs/catalog-service-pipeline/webhooks/</a><!-- raw HTML omitted -->/github</p>
</blockquote>
<p>To grab the <code>&lt;secret&gt;</code> we have to replace in the URL you can call the following command.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ oc get bc/catalog-service-pipeline -o json <span class="p">|</span> jq <span class="s1">&#39;.spec.triggers[].github.secret&#39;</span>
</span></span></code></pre></div><p>In your GitHub repository, select Add Webhook from Settings → Webhooks.
Paste the URL output (similar to above) into the Payload URL field.</p>
<blockquote>
<p><strong><em>Hint:</em></strong> <code>SSL Disable (not recommended)</code> if your cluster don&rsquo;t have a valid SSL certificate.
SSL verification
By default, we verify SSL certificates when delivering payloads.</p>
</blockquote>
<p><img src="/static/multiple-project-promoting/Add-GitHub-WebHook.png" alt="Add GitHub WebHook">
<img src="/static/multiple-project-promoting/GitHub-WebHooks.png" alt="GitHub WebHooks"></p>
<blockquote>
<p><strong><em>References:</em></strong><br>
<a href="https://blog.openshift.com/decrease-maven-build-times-openshift-pipelines-using-persistent-volume-claim/">https://blog.openshift.com/decrease-maven-build-times-openshift-pipelines-using-persistent-volume-claim/</a>
<a href="https://github.com/redhat-cop/container-pipelines/tree/master/basic-spring-boot">https://github.com/redhat-cop/container-pipelines/tree/master/basic-spring-boot</a></p>
</blockquote>
</article>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>
</div>
<script type="application/javascript" src='https://marzelwidmer.github.io/js/toc.js'></script>
<link rel="stylesheet" href='https://marzelwidmer.github.io/css/toc.css' />


  <div class="footer container-xl width-full p-responsive">
  <div
    class="position-relative d-flex flex-row-reverse flex-lg-row flex-wrap flex-lg-nowrap flex-justify-center flex-lg-justify-between flex-sm-items-center pt-6 pb-2 mt-6 f6 text-gray border-top border-gray-light ">
    <a aria-label="Homepage" title="GitHub" class="footer-octicon d-none d-lg-block mr-lg-4" href="https://marzelwidmer.github.io/">
      <svg height="24" class="octicon octicon-mark-github" viewBox="0 0 16 16" version="1.1" width="24">
        <path fill-rule="evenodd"
          d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z">
        </path>
      </svg>
    </a>
    <ul class="list-style-none d-flex flex-wrap col-12 flex-justify-center flex-lg-justify-between mb-2 mb-lg-0">
      
      <li class="mr-3 mr-lg-0">Theme by <a href='https://github.com/MeiK2333/github-style'>github-style</a></li>
      
    </ul>
  </div>
  <div class="d-flex flex-justify-center pb-6">
    <span class="f6 text-gray-light"></span>
  </div>


</div>
</body>

<script type="application/javascript" src="https://marzelwidmer.github.io/js/github-style.js"></script>




</html>